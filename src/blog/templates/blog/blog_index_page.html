{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags %}

{% block canonical_link %}
    {% if page_obj and page_obj.number > 1 %}
        <link rel="canonical" href="{{ request.build_absolute_uri }}">
    {% else %}
        {{ block.super }}
    {% endif %}
{% endblock %}

{% block extra_head %}
    {% if is_paginated %}
        {% if page_obj.has_previous %}
            {% if page_obj.previous_page_number == 1 %}
                <link rel="prev" href="{{ page.full_url }}">
            {% else %}
                <link rel="prev" href="{{ page.full_url }}?page={{ page_obj.previous_page_number }}">
            {% endif %}
        {% endif %}
        {% if page_obj.has_next %}
            <link rel="next" href="{{ page.full_url }}?page={{ page_obj.next_page_number }}">
        {% endif %}
    {% endif %}
{% endblock %}

{% block content %}
<section class="page-hero">
    <h1 class="page-title">{{ page.title }}</h1>
    {% if page.intro %}
        <p class="page-intro">{{ page.intro }}</p>
    {% endif %}
</section>

<section class="posts-grid">
    {% for post in posts %}
        <article class="post-card{% if not post.featured_image %} post-card--no-media{% endif %}">
            {% if post.featured_image %}
                <a href="{% pageurl post %}" class="post-card__media">
                    {% image post.featured_image fill-800x360 as img %}
                    <img src="{{ img.url }}" alt="{{ post.title }}">
                </a>
            {% endif %}
            <div class="post-card__content">
                {% if post.date %}
                    <span class="post-card__meta">{{ post.date }}</span>
                {% endif %}
                <h2 class="post-card__title"><a href="{% pageurl post %}">{{ post.title }}</a></h2>
                {% if post.abstract %}
                    <p class="post-card__excerpt">{{ post.abstract }}</p>
                {% elif post.search_description %}
                    <p class="post-card__excerpt">{{ post.search_description }}</p>
                {% endif %}
            </div>
        </article>
    {% empty %}
        <p class="page-intro">No posts yet.</p>
    {% endfor %}
</section>

{% if is_paginated %}
    <nav class="pagination" aria-label="Posts">
        {% if page_obj.has_previous %}
            <a class="pagination__link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        {% else %}
            <span class="pagination__link pagination__link--disabled">Previous</span>
        {% endif %}

        <span class="pagination__status">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a class="pagination__link" href="?page={{ page_obj.next_page_number }}">Next</a>
        {% else %}
            <span class="pagination__link pagination__link--disabled">Next</span>
        {% endif %}
    </nav>
{% endif %}
{% endblock %}
